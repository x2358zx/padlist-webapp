version: "3.9"
services:
  padlist-webapp:
    build: .
    container_name: padlist-webapp
    hostname: MSI # ★ 設定容器 Hostname，配合程式邏輯檢查 (2026/1/1修改)
    # 開發期保留直連 8000:8000 方便你繞過 nginx 測試；正式要用 nginx 時可註解掉這行
    #ports:
    #  - "8000:8000"
    restart: unless-stopped
    volumes:
      - ./app:/app # ★ Hot-reload code
      - ./uploads:/app/uploads # 讓 notices.json 永久落在宿主機
      - ./data:/app/data
    environment:
      # ★ 反向代理下要信任 X-Forwarded-*，FastAPI 會使用
      - TRUST_PROXY=1
      # DEPLOY_ENV removed per request
      # - DEPLOY_ENV=${DEPLOY_ENV:-test}
      # SUPERVISOR_USERS/DEV_ALLOW_LOCAL_EDITOR removed per request
      # - SUPERVISOR_USERS=${SUPERVISOR_USERS:-}
      # - DEV_ALLOW_LOCAL_EDITOR=${DEV_ALLOW_LOCAL_EDITOR:-1}
      - CHECK_HOSTNAME=1 # Enable hostname check (2026/1/1修改)
      - ALLOWED_HOSTNAME=${ALLOWED_HOSTNAME} # Pass from .env (2026/1/1修改)
      - NOTICES_FILE=/app/data/notices.json # << 新增：指定全站 notices.json 的絕對路徑
    # 若要把上傳目錄持久化可開啟
    # volumes:
    #   - ./app/uploads:/app/uploads

  nginx:
    image: nginx:1.27-alpine
    container_name: padlist-proxy
    depends_on:
      - padlist-webapp
    ports:
      # Windows 開發用 8080，Linux 正式可改成 "80:80"
      - "8002:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro # ← 單檔掛對位置
    restart: unless-stopped

networks:
  default:
    driver: bridge
